<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Login - JNV Cleaning</title>
  <style>
    html, body { margin:0; padding:0; height:100vh; width:100vw; background-color:wheat; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:#333; }
    #loginForm { position: fixed; width:420px; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,0.98); border-radius:1rem; padding:2rem 2.5rem; box-shadow:0 12px 30px rgba(0,0,0,0.12); display:flex; flex-direction:column; gap:.5rem; max-width:95vw; }
    @media (max-width:600px){ #loginForm{ width:92vw; padding:1.2rem; } }
    #loginForm h2{ font-weight:700; margin:0 0 .6rem; text-align:center; color:#5b4636; font-size:1.4rem; }
    label.small{ display:block; font-size:.9rem; font-weight:600; margin-bottom:6px; }
    #username{ border-radius:.6rem; font-size:16px; padding:.75rem 1rem; border:1px solid #c9b899; outline:none; }
    #enterBtn{ border-radius:.6rem; font-weight:700; font-size:1rem; padding:.8rem; background:#003366; border:none; color:#fff; cursor:pointer; box-shadow:0 6px 18px rgba(0,51,102,0.2); }
    #enterBtn:disabled{ opacity:.6; cursor:not-allowed; }
    #enterBtn:hover:not(:disabled){ background:#002244; }
    #errorMsg{ color:#b02a37; text-align:center; min-height:1.25rem; }
    .small-muted{ font-size:.85rem; color:#6b7280; text-align:center; margin-top:.6rem; }
  </style>
</head>
<body>

  <form id="loginForm" autocomplete="off">
    <h2>Welcome to JNV Cleaning</h2>

    <label class="small" for="username">Judge Name</label>
    <input id="username" name="username" type="text" placeholder="Enter your name" minlength="2" maxlength="40" required />

    <div id="errorMsg" aria-live="polite"></div>

    <button id="enterBtn" type="submit">Enter</button>

    <div class="small-muted">Only 3 judges allowed. Your name will be saved for this session.</div>
  </form>

  <script type="module">
import { db } from './firebase-config.js';
import {
  collection,
  getDocs,
  query,
  where,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

function $(id){ return document.getElementById(id); }
function showError(text){ $('errorMsg').textContent = text || ''; }

function withTimeout(promise, ms = 10000) {
  let timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms));
  return Promise.race([promise, timeout]);
}

// âœ… Put this before form handler so it exists when we call it
async function canJudgeLogin() {
    const scoresRef = collection(db, "scores");
    const snapshot = await getDocs(scoresRef);

    // Count unique judges
    const judgesSet = new Set();
    snapshot.forEach(doc => {
        const data = doc.data();
        if (data.judge) {
            judgesSet.add(data.judge);
        }
    });

    // Only allow up to 3 judges
    return judgesSet.size < 3;
}

const form = $('loginForm');
const usernameInput = $('username');
const enterBtn = $('enterBtn');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  showError('');
  const name = usernameInput.value.trim();

  if (!name || name.length < 2) {
    showError('Please enter a valid name (2+ characters).');
    return;
  }

  enterBtn.disabled = true;
  const previousText = enterBtn.textContent;
  enterBtn.textContent = 'Checking...';

  if (!db) {
    const ok = confirm('Firebase not available. Use local login for testing?');
    if (ok) {
      localStorage.setItem('judgeName', name);
      localStorage.setItem('judgeId', 'local-' + Math.random().toString(36).slice(2,9));
      window.location.href = 'index.html';
      return;
    } else {
      enterBtn.disabled = false;
      enterBtn.textContent = previousText;
      showError('Cannot log in without Firebase.');
      return;
    }
  }

  try {
    // 1) If a doc with the same name already exists -> reuse its doc id
    const sameNameQ = query(collection(db, 'judges'), where('name', '==', name));
    const sameNameSnap = await withTimeout(getDocs(sameNameQ), 10000);

    if (sameNameSnap && sameNameSnap.size > 0) {
      const existingDoc = sameNameSnap.docs[0];
      localStorage.setItem('judgeName', name);
      localStorage.setItem('judgeId', existingDoc.id);
      window.location.href = 'index.html';
      return;
    }

    // 2) Check if less than 3 judges have submitted scores
    const allowed = await canJudgeLogin();
    if (!allowed) {
      showError('Login limit reached. Only 3 judges allowed. Try again next week.');
      enterBtn.disabled = false;
      enterBtn.textContent = previousText;
      return;
    }

    // 3) Create a new judge (allowed because < 3 judges with scores)
    const newRef = await withTimeout(addDoc(collection(db, 'judges'), { name: name, createdAt: serverTimestamp() }), 10000);

    localStorage.setItem('judgeName', name);
    localStorage.setItem('judgeId', newRef.id);
    window.location.href = 'index.html';

  } catch (err) {
    console.error('Login error:', err);
    const fallback = confirm('Could not contact Firebase (network, rules or timeout). Do you want to continue with local login for testing?');
    if (fallback) {
      localStorage.setItem('judgeName', name);
      localStorage.setItem('judgeId', 'local-' + Math.random().toString(36).slice(2,9));
      window.location.href = 'index.html';
      return;
    } else {
      showError('Login failed. Check console for details.');
    }
  } finally {
    enterBtn.disabled = false;
    enterBtn.textContent = previousText;
  }
});
</script>



</body>
</html>
